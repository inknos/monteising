\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[a4paper]{geometry}

\usepackage[english]{babel}
\hyphenation{sil-la-ba-zio-ne pa-ren-te-si}
\usepackage{newlfont}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage {amsmath, amssymb}
\usepackage{bbm}

\usepackage{graphicx}
\usepackage{rotating}
%\usepackage{subfigure}
\usepackage{lscape}
\usepackage[bf, scriptsize]{caption}
\usepackage{multirow}
\usepackage{longtable}
\hyphenation{Low-din}
\usepackage{titling}
\usepackage{eurosym}
\usepackage{adjustbox}

\usepackage{subcaption}%used by Nicola for multiple image

% included by Nicola for correct highlighting of C++ code
\usepackage{listings}
\usepackage{xcolor}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{dred}{rgb}{0.545,0,0}
\definecolor{dblue}{rgb}{0,0,0.545}
\definecolor{lgrey}{rgb}{0.9,0.9,0.9}
\definecolor{gray}{rgb}{0.4,0.4,0.4}
\definecolor{darkblue}{rgb}{0.0,0.0,0.6}

\lstdefinelanguage{cpp} {
  backgroundcolor=\color{lgrey},
  basicstyle=\footnotesize \ttfamily \color{black} \bfseries,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  commentstyle=\color{dkgreen},
  deletekeywords={...},
  escapeinside={\%*} {*)},
  frame=single,
  language=C++,
  keywordstyle=\color{purple},
  morekeywords={BRIEFDescriptorConfig,string,TiXmlNode,DetectorDescriptorConfigContainer,istringstream,cerr,exit},
  identifierstyle=\color{black},
  stringstyle=\color{blue},
  numbers=left,
  numbersep=5pt,
  numberstyle=\tiny\color{black},
  rulecolor=\color{black},
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  stepnumber=1,
  tabsize=2,
  title=\lstname,
}
% end inclusion

\author{F. Cinus \& F. Delussu \& N. Sella}
\title{\includegraphics[scale=0.12]{Unito-logo} \\ \LARGE{UNIVERSIT\`{A} DEGLI STUDI DI TORINO}
  \\
  TANS Course A.A. 2017/2018 Prof. Massimo Masera
  \\
  \textbf{Ising Model Simulation with MC methods}
}

\begin{document}
\date{}
\maketitle
\bigskip
\section*{Abstract}
A computational solution for the Ising model is proposed using Metropolis-Hastings algorithm. Results show critical temperature for 2D and 3D models under periodic boundary conditions. Different sizes and temperatures are studied in agreement with algorithm performances and sensibilities to the parameters. We plotted energy, susceptibility and magnetization vs temperature and we fitted it in order to find critical exponent.


% -----------------------------PAG 1----------------------------------%
\newpage
\section*{Introduction}
The Ising model is a well studied model in Statistical Mechanics which describes ferromagnetic phenomena. It is characterized by a microscopic configuration space based on D-dimensional lattice, that brings to macroscopic statistical quantities. Moreover it can easily generalize the concept of collective effects caused by binary valued points interacting in pairs; for this reason the Ising model became the core of the physics of complex systems. In the last decades computational methods have been applied to search a numerical solution for the 3D Ising model in order to  fill the lack of an analytical solution.
\\
Alongside Metropolis algorithm became the most popular method of important sampling in MC. The basic idea of a weighted sampling based on the importance of a region determined a great improvement for the numerical solutions in general. Under these premises we want to outline the purpose this work wants to pursuit: finding numerical solution of the D-dimensional Ising model with Metropolis algorithm.


\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.25]{img/img1_intro.jpg}
  \caption[Source: "monteinsing code" https://inknos.github.io/monteising/]{High temperature simulation of 3D Ising model}
  \includegraphics[scale=0.25]{img/img2_intro.jpg}
  \caption[Source: "monteinsing code" https://inknos.github.io/monteising/]{Low temperature simulation of 3D Ising model}
\end{figure}


% -----------------------------PAG 2----------------------------------%
\newpage
\section{Theory}
\subsection{Ising model and importance sampling}
The Ising model is a physical-mathematical model characterized by a lattice of local spins in the [-1;+1] domain. The correspondent energy is proportional to the quadratic interaction of near spins ($\sigma_i$):

\begin{equation}
  H(q, \sigma) = \sum_{<l,m>}^{'} -J\sigma_i\sigma_j
\end{equation}
Where $J$ is the energy interaction term and we sum over the neighbours.
\\
The system has  a macroscopic equilibrium state (macrostate) described by statistical quantities: number of spins $N$, lattice volume $V$, energy $E$, magnetization $M$. According to the Statistical Mechanics theory we consider the thermodynamic limit, i.e. $N, V \rightarrow \infty$ and $N/V = cost$ in order to have negligible fluctuations on energy and magnetisation: $(\Delta E)^2 / \langle E \rangle = O  (1/ \sqrt{N}) $.
From a theoretical point of view we consider an ensemble of lattices, each one with a particular configuration of spins (microstate) that corresponds to the same macrostate; we point out that all microstates are independent and equiprobable. The configuration space is described through the Hamiltonian formalism indeed, under ergodic hypothesis, the system visits all microstates. Moreover stationary hypothesis implies the existence of at least an equilibrium state in which  the probability distribution of the microstates satisfies the Liouville theorem. These hypotheses bring respectively to the following statements:

\begin{enumerate}
\item In the $t \rightarrow \infty$ limit: the average (over all the ensemble) of a physical quantity is equal to the temporal average of that quantity.
\item The probability distribution of the microstates depends only on the Hamiltonian:
  \begin{equation}
    \rho (q, \sigma ) \propto \exp \lbrace- \beta H(q, \sigma ) \rbrace
  \end{equation}
  Where $q$ is the spin position on the lattice and $\beta$ is the product of the Boltzmann constant and the temperature $T$ of the system.
\end{enumerate}
In a finite case the Ising model system is characterized by magnetization and  energy fluctuations that brings us to consider it under canonical formalism. We define the partition function as follows: $Z = \sum_q exp [  -\beta H(q) ]$. The model simulation can be done through Monte Carlo method, i.e. we generate a pseudo-random chain of numbers in order to extract a microstate sample (from all the configuration space) distributed by the following equilibrium distribution of probability:
\begin{equation}
  P_{eq}(q)=\exp \lbrace -\beta H(q)\rbrace /Z
\end{equation}
In practice we cannot compute the partition function, moreover an algorithm that searches over all the phase space has not a great performance.


% -----------------------------PAG 3----------------------------------%
\newpage
The Boltzmann's factor as probability of choosing a configuration gives a great improvement for the simulation. In this way we are not sampling all the configuration space but a selected and uniform distributed microstates collection. This approach is called \textit{importance sampling} and it allows us to calculate physical quantities as the average number over the extracted configuration:
$$
  \langle E \rangle_N = \dfrac{1}{N} \sum_{i=1}^{N}{E(q_i)}
$$
This intuition can be proved under ergodic hypothesis: in fact we can consider an evolving Ising system in which there is a spin flip at each time step. The temporal collection of microstates is a Markov chain with a transition probability ($W$) that leads the system to the unique equilibrium probability in the $t \rightarrow \infty$ limit. Indeed the ratio of the transition probability is:
\begin{equation}
\dfrac{W(q \rightarrow q')}{W(q' \rightarrow q)} = \dfrac{P_{eq}(q')}{P_{eq}(q)}= \exp \lbrace \beta [E(q) - E(q')] \rbrace 
\end{equation}
Where $q$ and $q'$ are respectively the configuration before the spin-flip and after. This implies the equivalence between importance sampling and random extraction. The arbitrary choose on $W(q \rightarrow q')$ determines the particular algorithm; for the Metropolis-Hastings algorithm:
\begin{eqnarray}
W(q \rightarrow q') = min \bigg \lbrace 1 , \dfrac{P_r(q')P_{eq}(q')}{P_r(q)P_{eq}(q)} \bigg \rbrace
\end{eqnarray}
Where $P_r(q)$ is the probability to be in the $q$ configuration; we consider symmetric probability: $P_r(q)=P_r(q')$. In this way the configuration $q'$ is more probable than $q$ if $P_{eq}(q')>P_{eq}(q)$ and the step transition could occur with the following probabilities and conditions: 
\[
\begin{cases}
  W(q \rightarrow q')=1 &\quad \Delta E \leq 0 \\
  W(q \rightarrow q')=\exp \lbrace -\beta  \Delta E  \rbrace  &\quad \Delta E > 0
\end{cases}
\]
\bigskip

\subsection*{Phase transition in Ising model}
Magnetization in Ising model shows phase transition at a certain temperature called $T_c$. This means that the logarithm of the partition function has a critical point of the first order at this temperature and two different statistical descriptions concurrently exist at $T_c$. Indeed the magnetization curve has two different fits before this point and after, these fits correspond to inner configuration of spins: random for $\langle M \rangle = 0$ and ordered for $\langle M \rangle \rightarrow +1 / -1$.





% -----------------------------PAG 4----------------------------------%
\newpage


\section{Model}

\subsection{Lattice Implementation}

A D-dimensional Lattice with N spins along each edge is described by:
$$\mathbf{L} = (L_0,L_1,..,L_{N^D-1})$$
Let $i$ denote the index of array $\mathbf{L}$: $i = \{0,1,...,N^D -1\}$.\\
$L_i = \{0,1\}$ is a boolean entry representing down and up spin by convention. \\
Let $i$-spin denote the spin represented by the $L_i$ boolean entry. \\
The cartesian coordinates $\mathbf{a} = (a_0,a_1,..,a_{D-1})$ of the $i$-spin can be computed from index $i$ if a convention is set on the Lattice arrangement, which in our model is the following:
\begin{itemize}
\item Origin \textit{O} of the D-dimensional space is a spin-vertex of the cubic Lattice, each edge starting from \textit{O} is aligned along one of the D positive directions.
\item Unitary distance between each couple of adjacent spins.
\item Spins are indexed starting from increasing the first dimension’s coordinate, than the second and so forth.
\item[\textbf{n.b.}] This rules imply that, given a specific spin, each coordinate $a_j$ takes values in range $\{0,1,…,N-1\}$. \\
\end{itemize}
Index $i$ can be expressed as a power series of N with coefficients $a_j$:

\begin{equation}
i = \sum_{j=1}^{D-1}a_jN^j
\end{equation}
The $a_j$ coordinates can then be computed from $i$ as:
\begin{equation}
a_j = [i\%N^{j+1}]/N^j
\end{equation}

% -----------------------------PAG 6----------------------------------%

\newpage
\subsection{Energy Computation}

The Lattice's energy is computed according to equation (1).
The Lattice class provides a method which returns the energy of the system. \\
The implemented algorithm takes the lattice array $\mathbf{L}$ and performs two for loops:\\ 
one over the system's dimension $d = (0,1,..,D-1)$ and the other over the index $i = (0,1,..,N^D-1)$. \\
The key idea is that, given a fixed $i$-spin, along each dimension $d$, two neighbours $i_{d_\pm}$-spin are found on the increasing and decreasing d-coordinate respectively.
\\So each single spin has $2D$ interacting neighbours in total, by summing up their energy interaction terms the contribute of the single spin to the total energy is obtained. So the energy can be rewritten as:
\begin{equation}
H = \frac{1}{2}\sum_{i=0}^{N^D-1}\sum_{d=0}^{D-1}\sum_{\pm}^{} -J\sigma_i\sigma_{i_{d_\pm}}
\end{equation}
Performing $\sum_{i}^{}$ , double countings of couples occur and a factor $1/2$ is required. \\
For each fixed index $i$ ,the algorithm takes into account only the interaction term with the
$i_{d_+}$-spin so that the number of operation is halved. So the algorithm computes:

\begin{equation}
H = \sum_{i=0}^{N^D-1}\sum_{d=0}^{D-1}-J(L_i \ \oplus \ L_{i_{d_+}})
\end{equation}
$\sigma_i\sigma_{i_{d_+}}$ has been replaced by $L_i \ \oplus \ L_{i_{d_+}}$ , the former can take values $\pm1$ wether the two spins are aligned or not. Since spins are represented by boolean entries of array $L_i$, the XOR bitwise operator $\oplus$ is applied on couple $(L_i,L_{i_{d_+}})$ so that it returns the same value of $\sigma_i\sigma_{i_{d_+}}$. \\
\vspace{0.1cm}
From the $i$ index coordinates $\mathbf{a} = (a_0,a_1,..,a_{D-1})$ the $i_{d_+}$ index coordinates\\
$\mathbf{a^{d_+}} = (a^{d_+}_0,a^{d_+}_1,..,a^{d_+}_{D-1})$ can be computed. \\
The vector $\mathbf{a^{d_+}}$ differs from $\mathbf{a}$
only on the $d$ entry $a^{d_+}_d$ which is the only one to be increased, this is computed as $(a_d+1)\%N$ since we are applying periodic boundary conditions on the Lattice. \\
From this formulas we can express the $i_{d_+}$ index as the sum of two terms:
\begin{eqnarray*}
  i_{d_+} &=& \left\{ \sum_{j = 0}^{d-1}a_jN^j + [(a_d + 1)\%N]N^d \right\} + \left\{ \sum_{j = d+1}^{D-1}a_jN^j \right\}  \\
          &=& \left\{(i + N^d)\%N^{d+1} \right\}  +  \left\{ (i/N^{d+1})N^{d+1}  \right\}
\end{eqnarray*}
\textbf{n.b.} : if $d = D-1$ the second term equals 0, so it is not computed by the algorithm
\newpage


\subsection{Metropolis Algorithm}

At each step Metropolis Algorithm proposes a Lattice configuration $q'$ which differs from the initial configuration $q$ only by one spin value.\\ 
The number of possible $q'$ configurations is equal to the total number of spins $N^D$; $q'$ is chosen with uniform probability.
\\Defining the ratio $a = P_{eq}(q')/P_{eq}(q)$ 
\begin{enumerate}
	\item If $a \geq 1$ than $q'$ is accepted 
	\item If $a < 1$ :
		\begin{itemize}
			\item[] $q'$ is accepted with probability $a$
			\item[] if $q'$ is rejected (with probability $1-a$) configuration $q$ is kept
		\end{itemize}				 
\end{enumerate}
That means $q'$ is always accepted when its probability is greater than $q$ , otherwise it is accepted with 
probability $P_{eq}(q')/P_{eq}$.\\
\\
According to formula (3) $a = \exp \lbrace -\beta  \Delta E  \rbrace$; it is easy to observe that when $a \geq 1$ than $ \Delta E \leq 0 $. The latter inequality is taken as the condition of point 1.  
\\
\\
The Algorithm's single step is implemented as following:
	
\begin{enumerate}
	
	\item Random integer $i$ is extracted with uniform probability from $\{0,1,...,N^D -1\}$
	\item The energy variation $ \Delta E $ resulting from flipping the $i-spin$ is computed		
	\item If $\Delta E \leq 0 $ than the $i$-spin is flipped
	\item If $\Delta E > 0 $ :
		\begin{itemize}
			\item[]  A random double number $u$ is extracted with uniform probability from $[0,1]$
			\item[]	 if $u < \exp \lbrace -\beta  \Delta E  \rbrace $					
			\begin{itemize}
				\item[] $i$-spin is flipped 
			\end{itemize}				 	 
			\item[]	 if $u > \exp \lbrace -\beta  \Delta E  \rbrace $
			\begin{itemize}
				\item[] $i$-spin is not flipped 
			\end{itemize}					
		\end{itemize}				 
\end{enumerate}
% -----------------------------PAG 8----------------------------------% 
\newpage
\section{Results}
This section wants to summarize the simulation results. Under this purpose we point out two main effects:

\begin{itemize}
\item Finite size and finite volume of the lattice imply magnetization and energy fluctuations; periodic conditions reduce this phenomena. Moreover finite size leads to no residual magnetization: this effect is out of the temperature's range studied.

\item Importance sampling algorithms can produce correlated configurations corresponding to different steps of the simulation. This phenomena is in contrast with theoretical hypothesis of microstates independence and can be correctly treated through binning technique. 
\end{itemize}

\subsubsection*{Calibrating the model}
Simulations are done with $10^8$ steps for thermalization ($10^9$ for the 3D lattice) and more than $10^7$ steps with useful data. We varied the lattice size from 40x40 to 100x100 number of spins. Simulation time is really sensible to the number of temperature steps. We choose 100 steps of temperature from 0.5K to 3.5K centered around theoretical critical temperature (2.27K for 2D, 4K for 3D). (See Figure 12 in Appendix) 

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/2d/c1.pdf}
  \caption{Energy-Temperature graph for 2D Lattices with I=10,000,000 and 100 steps of T}
  \label{fig:ET2D}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/2d/c2.pdf}
  \caption{Magnetization-Temperature graph for 2D Lattices with I=10,000,000 and 100 steps of T}
  \label{fig:MT2D}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/2d/c3.pdf}
  \caption{Susceptibility-Temperature graph for 2D Lattices with I=10,000,000 and 100 steps of T}
  \label{fig:XT2D}
\end{figure}

\begin{figure}[h!]
  \begin{subfigure}{.5\columnwidth}
    \centering
    \includegraphics[trim={2.5cm 1.7cm 2.5cm 1.5cm}, clip, width=\columnwidth]{img/2DnoCooling.pdf}
    \caption{Before cooling}
    \label{fig:2DBC}
  \end{subfigure}
  \begin{subfigure}{.5\columnwidth}
    \centering
    \includegraphics[trim={2.5cm 1.7cm 2.5cm 1.5cm}, clip, width=\columnwidth]{img/2Dcooling.pdf}
    \caption{After Cooling}
    \label{fig:2DAC}
  \end{subfigure}
  \caption{10,000,000 steps of cooling for the 2D Lattice with L=100}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/3d/c1.pdf}
  \caption{Energy-Temperature graph for 3D Lattices with I=40,000,000 and 25 steps of T}
  \label{fig:ET3D}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/3d/c2.pdf}
  \caption{Magnetization-Temperature graph for 3D Lattices with I=40,000,000 and 25 steps of T}
  \label{fig:MT3D}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/3d/c3.pdf}
  \caption{Susceptibility-Temperature graph for 3D Lattices with I=40,000,000 and 25 steps of T}
  \label{fig:XT3D}
\end{figure}

\begin{figure}[h!]
  \includegraphics[trim={1cm 1cm 1cm 1cm}, clip, width=\columnwidth]{img/3Dcooling.pdf}
  \caption{1,000,000,000 steps of cooling for the 3D Lattice with L=40}
  \label{fig:3DC}
\end{figure}



The binning method can take into account the correlation between different configurations. Measures corresponding to different steps of the simulation can have a correct error valuation through this technique: we divide a set of $N$ ordered configurations in $N/2^n$ groups (each one with $n$ elements), we calculate the mean for each bin and we iterate this process until the desired level of binning; then we calculate the global mean and its error. In this way we correlate the measure at a particular level of binning (higher level $\rightarrow$ correlation length $<<$ size of the bins $\rightarrow$ lower correlation $\rightarrow$ higher error). We chose the eighth level of binning for which we found a plateau in the error-level graph. 

\begin{figure}[h!]
  \centering
  \includegraphics[width=\columnwidth]{img/binning.pdf}
  \caption{Binning}
  \label{fig:binning}
\end{figure}

% -----------------------------PAG 8----------------------------------%
\newpage
\section{Conclusions}
Metropolis-Hastings algorithm has been implemented in Root (C++) in order to show phase transitions in the 2D and 3D Ising model. Simulation parameters are the following:

\begin{center}
  \framebox[12cm]{%
    \begin{minipage}{100mm}
      \begin{itemize}
      \item number of spins for side: $40$-$60$-$80$-$100$ 
      \item thermalization steps: $10^8$-$10^9$ 
      \item data collection steps: $>10^7$ 
      \item temperature measures: $25-100$ 
      \end{itemize}
    \end{minipage}}
\end{center}



We recall the theoretical critical temperature of the 2D Ising model with infinite size: 2.27K. The 3D Ising model does not have an analytical solution so we present a result in harmony with the results accepted by scientific community.
\begin{center}
  \begin{tabular}{c|c|c}
 	Model & Critical T & Critical Exp  \\
    \hline    
    \hline
    2D & Numb. Users & Max Delivery Cost \\
    \hline
    \hline
    3D & 700         & 1.75 \euro{}     \\
    \hline
  \end{tabular}
\end{center}


 


\newpage

\section{Appendix}
\subsection*{Code}
This section's aim is to introduce the reader to the C++ implementation of the model. The code is based on TObject class of Root and its scheme is the following:

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.45]{img/Schema_classi.png}
  \caption{Class scheme}
\end{figure}
\newpage

\input{classes.tex}





% for SVG
% inkscape -D -z --file=Schema_classi.svg --export-pdf=Schemaclassi.pdf --export-latex
% \begin{figure}
%   \centering
%   \def\svgwidth{\columnwidth}
%   \input{img/Schemaclassi.pdf_tex}
% \end{figure}
% end svg











% -----------------------------PAG 7----------------------------------%



% -----------------------------PAG 9----------------------------------%
\newpage
\appendix
\subsection*{Performance}
\begin{figure}[h!]
  \centering
   \includegraphics[width=\columnwidth]{img/Andamenti_performance.pdf} 
  \caption{Time scaling for different data member initialization}

\end{figure}

\end{document}